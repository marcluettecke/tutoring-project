<div class="results-page">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Análisis de Resultados</h1>
    <p class="page-description">Explora y compara tus sesiones de práctica y exámenes</p>
  </div>

  <!-- Global Session Selection Controls -->
  <div class="session-controls">
    <!-- Session Selectors -->
    <div class="session-selectors">
      <!-- First Session Selector -->
      <div class="selector-group">
        <app-session-selector
          [sessions]="allSessions"
          [selectedSessionId]="selectedSessionId1"
          [label]="'Primera sesión:'"
          [currentSessionText]="'-- Seleccionar sesión --'"
          [groupByMode]="true"
          (sessionSelect)="onSessionSelect($event)">
        </app-session-selector>
      </div>

      <!-- Second Session Selector (always visible when first session is selected) -->
      @if (selectedSession1) {
        <div class="selector-group">
          <app-session-selector
            [sessions]="getFilteredSessions()"
            [selectedSessionId]="selectedSessionId2"
            [label]="'Segunda sesión:'"
            [currentSessionText]="'-- Seleccionar sesión (opcional) --'"
            [groupByMode]="true"
            (sessionSelect)="onSession2SelectFromSelector($event)">
          </app-session-selector>
        </div>
      }
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button 
      class="tab-button"
      [class.active]="activeTab === 'data'"
      (click)="switchTab('data')">
      <fa-icon [icon]="faTable"></fa-icon>
      <span>Datos</span>
    </button>
    <button 
      class="tab-button"
      [class.active]="activeTab === 'charts'"
      (click)="switchTab('charts')">
      <fa-icon [icon]="faChartBar"></fa-icon>
      <span>Gráficos</span>
    </button>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">
    @if (activeTab === 'data') {
      <!-- Data Tab Content -->
      <div class="data-tab">
        <!-- Results Display Area -->
        <div class="results-display">
          @if (selectedSession1 && viewMode === 'single') {
            <!-- Single Session View -->
            <div class="single-session-view">
              <!-- Session Summary -->
              <div class="session-summary">
                <h3>Detalles de la sesión</h3>
                <table class="summary-table">
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Tipo</th>
                      <th>Sección</th>
                      @if (selectedSession1.subSection) {
                        <th>Subsección</th>
                      }
                      <th>Preguntas</th>
                      <th>Correctas</th>
                      <th>Incorrectas</th>
                      @if (selectedSession1.mode === 'test') {
                        <th>En blanco</th>
                      }
                      <th>Precisión</th>
                      <th>Tiempo total</th>
                      <th>Tiempo/pregunta</th>
                      @if (selectedSession1.testScore !== undefined) {
                        <th>Puntuación</th>
                      }
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>{{ selectedSession1.timestamp | date:'dd/MM/yyyy HH:mm' }}</td>
                      <td>{{ getSessionTypeText(selectedSession1) }}</td>
                      <td>{{ selectedSession1.mainSection }}</td>
                      @if (selectedSession1.subSection) {
                        <td>{{ selectedSession1.subSection }}</td>
                      }
                      <td>{{ selectedSession1.questionsAnswered }}</td>
                      <td>
                        <span class="count-badge correct">{{ selectedSession1.correctAnswers }}</span>
                      </td>
                      <td>
                        <span class="count-badge wrong">{{ selectedSession1.incorrectAnswers }}</span>
                      </td>
                      @if (selectedSession1.mode === 'test') {
                        <td>
                          <span class="count-badge blank">{{ selectedSession1.blankAnswers || 0 }}</span>
                        </td>
                      }
                      <td>
                        <span class="accuracy-badge" [class]="getSessionAccuracyClass(selectedSession1)">
                          {{ formatSpanishPercentage(getSessionAccuracy(selectedSession1), 1) }}
                        </span>
                      </td>
                      <td>{{ formatTimeFromSeconds(selectedSession1.timeSpent || 0) }}</td>
                      <td>{{ formatAverageTimePerQuestion(selectedSession1) }}</td>
                      @if (selectedSession1.testScore !== undefined) {
                        <td>
                          <strong>{{ formatSpanishNumber(selectedSession1.testScore, 2) }}</strong>
                        </td>
                      }
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <br>
              
              <!-- Session Data Table -->
              <app-session-data-table
                [sectionBreakdown]="session1SectionBreakdown"
                [session]="selectedSession1"
                [sessionLabel]="getSessionLabel(selectedSession1, 'Sesión actual')"
                [showEmptyState]="hasEmptyBreakdown(session1SectionBreakdown)"
                emptyStateTitle="Sesión sin desglose detallado"
                emptyStateDescription="Esta sesión no contiene información detallada por secciones.">
              </app-session-data-table>
            </div>
          } @else if (selectedSession1 && selectedSession2 && viewMode === 'compare') {
            <!-- Comparison View -->
            <app-session-comparison-table
              [session1]="selectedSession1"
              [session2]="selectedSession2"
              [session1Label]="getSessionLabel(selectedSession1, 'Primera sesión')"
              [session2Label]="getSessionLabel(selectedSession2, 'Segunda sesión')">
            </app-session-comparison-table>
          } @else if (!selectedSession1) {
            <!-- Empty State -->
            <div class="empty-state">
              <div class="empty-icon">
                <fa-icon [icon]="faChartBar" size="3x"></fa-icon>
              </div>
              <h3>Selecciona una sesión para comenzar</h3>
              <p>Elige una sesión de práctica o examen para ver los detalles y análisis.</p>
            </div>
          } @else if (viewMode === 'compare' && !selectedSession2) {
            <!-- Comparison Empty State -->
            <div class="empty-state">
              <div class="empty-icon">
                <fa-icon [icon]="faArrowRight" size="3x"></fa-icon>
              </div>
              <h3>Selecciona una segunda sesión</h3>
              <p>Elige otra sesión para comparar con la primera seleccionada.</p>
            </div>
          }
        </div>
      </div>
    } @else if (activeTab === 'charts') {
      <!-- Charts Tab Content -->
      <div class="charts-tab">
        <!-- Charts Display Area -->
        <div class="charts-display">
          @if (selectedSession1 && viewMode === 'single') {
            <!-- Single Chart View -->
            <app-charts-container
              [currentData]="chartData1"
              [previousSessions]="[]"
              [selectedSessionId]="'current'"
              [selectedSession]="null"
              [showComparison]="false"
              [comparisonMode]="'individual'"
              [canCompare]="false"
              [comparisonTooltip]="''"
              [isProgressTracking]="false"
              (sessionChanged)="onChartSessionChanged($event)"
              (comparisonModeChanged)="onChartComparisonModeChanged($event)">
            </app-charts-container>
          } @else if (selectedSession1 && selectedSession2 && viewMode === 'compare') {
            <!-- Comparison Chart View -->
            <app-charts-container
              [currentData]="chartData1"
              [previousSessions]="[selectedSession2]"
              [selectedSessionId]="selectedSession2.id"
              [selectedSession]="selectedSession2"
              [showComparison]="true"
              [comparisonMode]="'compare'"
              [canCompare]="true"
              [comparisonTooltip]="'Comparando dos sesiones seleccionadas'"
              [isProgressTracking]="false"
              (sessionChanged)="onChartSessionChanged($event)"
              (comparisonModeChanged)="onChartComparisonModeChanged($event)">
            </app-charts-container>
          } @else if (!selectedSession1) {
            <!-- Empty State for Charts -->
            <div class="charts-empty-state">
              <div class="empty-icon">
                <fa-icon [icon]="faChartLine" size="3x"></fa-icon>
              </div>
              <h3>Selecciona una sesión para ver los gráficos</h3>
              <p>Los gráficos mostrarán el análisis visual de la sesión seleccionada con opciones de comparación.</p>
            </div>
          } @else if (viewMode === 'compare' && !selectedSession2) {
            <!-- Comparison Empty State -->
            <div class="charts-empty-state">
              <div class="empty-icon">
                <fa-icon [icon]="faArrowRight" size="3x"></fa-icon>
              </div>
              <h3>Selecciona una segunda sesión</h3>
              <p>Elige otra sesión para comparar gráficamente con la primera seleccionada.</p>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>