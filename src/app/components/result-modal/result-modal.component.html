<div class="backdrop" [class.minimized]="isMinimized" (click)="!isMinimized && handleCloseClick()"></div>

<div class="result-modal" [class.minimized]="isMinimized">
  <div class="modal-header">
    <h2 class="result-title">Resultados de tu prueba</h2>
    <button 
      class="minimize-button"
      (click)="toggleMinimize()"
      [title]="isMinimized ? 'Maximizar' : 'Minimizar'">
      <fa-icon [icon]="isMinimized ? faExpand : faMinus"></fa-icon>
    </button>
  </div>

  @if (!isMinimized) {
    <div class="modal-content">
    <div class="tab-navigation">
      <button 
        class="tab-button"
        [class.active]="activeTab === 'data'"
        (click)="switchTab('data')">
        <fa-icon [icon]="faTable"></fa-icon>
        <span>Datos</span>
      </button>
      <button 
        class="tab-button"
        [class.active]="activeTab === 'charts'"
        (click)="switchTab('charts')">
        <fa-icon [icon]="faChartBar"></fa-icon>
        <span>Gráficos</span>
      </button>
    </div>

    <div class="tab-content">
    @if (activeTab === 'data') {
      <div class="data-tab">
        @if (!isProgressTracking) {
          <div class="performance-summary">
            <div class="overall-score" [class]="getSectionPerformanceLevel('total')">
              <div class="score-circle">
                @if (selectedSession && selectedSessionId !== 'current' && comparisonMode === 'individual') {
                  <div class="score-value">{{ formatSpanishNumber(selectedSession.testScore || selectedSession.score || 0, 2) }}</div>
                  <div class="score-label">Puntuación del examen</div>
                  <div class="score-explanation">({{ formatSessionForDropdown(selectedSession) }})</div>
                } @else {
                  <div class="score-value">{{ formatSpanishNumber(overallScore, 2) }}</div>
                  <div class="score-label">Puntuación del examen</div>
                  <div class="score-explanation">(Correcto: +1, Incorrecto: -0,33)</div>
                }
              </div>
              <div class="accuracy-display">
                @if (selectedSession && selectedSessionId !== 'current' && comparisonMode === 'individual') {
                  <div class="accuracy-value">{{ formatSpanishPercentage(getHistoricalAccuracy(), 2) }}</div>
                  <div class="accuracy-label">Precisión</div>
                  <div class="accuracy-explanation">({{ selectedSession.correctAnswers }}/{{ selectedSession.questionsAnswered }} correctas)</div>
                } @else {
                  <div class="accuracy-value">{{ formatSpanishPercentage(overallAccuracy, 2) }}</div>
                  <div class="accuracy-label">Precisión</div>
                  <div class="accuracy-explanation">({{ correctAnswers.total.correct || 0 }}/{{ (correctAnswers.total.correct || 0) + (correctAnswers.total.incorrect || 0) }} correctas)</div>
                }
              </div>
            </div>

          </div>
        }

        @if (isProgressTracking && (progressSession || selectedSession)) {
          @if (previousSessions.length > 0) {
            <div class="comparison-selector">
              <label for="session-select">Comparar con sesión anterior:</label>
              <div class="select-container">
                <select 
                  id="session-select" 
                  [(ngModel)]="selectedSessionId" 
                  (change)="onSessionSelect()"
                  class="session-dropdown">
                  <option value="current">📊 Sesión actual (sin guardar)</option>
                  @for (session of previousSessions; track session.id) {
                    <option [value]="session.id">{{ formatSessionForDropdown(session) }}</option>
                  }
                </select>
                @if (showComparison) {
                  <div class="comparison-controls">
                    <button 
                      class="mode-toggle" 
                      [disabled]="!canCompare"
                      [class.disabled]="!canCompare"
                      (click)="canCompare && toggleComparisonMode()" 
                      [title]="comparisonTooltip">
                      @if (comparisonMode === 'individual') {
                        <span>📊</span>
                      } @else {
                        <span>📋</span>
                      }
                    </button>
                  </div>
                }
              </div>
            </div>
          }

          @if (comparisonMode === 'individual') {
            @if (displaySectionBreakdown && displaySectionBreakdown.length > 0) {
              <div class="section-breakdown">
                <h3>Desglose por secciones 
                  @if (selectedSessionId === 'current' || !selectedSession) {
                    <span class="session-indicator">(Sesión actual)</span>
                  } @else if (selectedSession) {
                    <span class="session-indicator">({{ formatSessionForDropdown(selectedSession) }})</span>
                  }
                </h3>
                <div class="breakdown-table-container">
                <table class="breakdown-table">
                  <thead>
                    <tr>
                      <th>Sección</th>
                      <th>Subsección</th>
                      <th>Preguntas</th>
                      <th>Correctas</th>
                      <th>Incorrectas</th>
                      <th>Precisión</th>
                      <th>Tiempo total</th>
                      <th>Tiempo/pregunta</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (section of displaySectionBreakdown; track section.sectionName + (section.subSection || '')) {
                      <tr class="breakdown-row">
                        <td class="section-name">{{ getSectionDisplayName(section.sectionName) }}</td>
                        <td class="subsection-name">{{ section.subSection || '-' }}</td>
                        <td class="question-count">{{ section.questionsAnswered }}</td>
                        <td class="correct-count">
                          <span class="count-badge correct">{{ section.correctAnswers }}</span>
                        </td>
                        <td class="incorrect-count">
                          <span class="count-badge wrong">{{ section.incorrectAnswers }}</span>
                        </td>
                        <td class="accuracy-rate">
                          <span class="accuracy-badge" [class]="getSectionAccuracyLevel(section)">
                            {{ formatSpanishPercentage(getSectionAccuracy(section), 1) }}
                          </span>
                        </td>
                        <td class="time-total">{{ formatTimeSpent(section.timeSpent) }}</td>
                        <td class="time-per-question">{{ formatAverageTimePerQuestion(section) }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            </div>
            } @else {
              <div class="empty-session-placeholder">
                <div class="placeholder-icon">
                  <fa-icon [icon]="faChartBar"></fa-icon>
                </div>
                <h3>Sesión sin datos</h3>
                <p>No se respondieron preguntas durante esta sesión de seguimiento.</p>
                <p>Para generar estadísticas, responde algunas preguntas mientras el seguimiento esté activo.</p>
              </div>
            }
          }

          @if (comparisonMode === 'compare' && selectedSession) {
            <app-session-comparison-table
              [session1]="getCurrentSessionAsTestSession()"
              [session2]="selectedSession"
              [session1Label]="'Sesión Actual'"
              [session2Label]="formatSessionForDropdown(selectedSession)">
            </app-session-comparison-table>
          }
        }

  @if (!isProgressTracking) {
    <div class="comparison-selector">
      <label for="test-session-select">Comparar con examen anterior:</label>
      <div class="select-container">
        <select 
          id="test-session-select" 
          [(ngModel)]="selectedSessionId" 
          (change)="onSessionSelect()"
          class="session-dropdown">
          <option value="current">📊 Examen actual (sin guardar)</option>
          @for (session of previousSessions; track session.id) {
            <option [value]="session.id">{{ formatSessionForDropdown(session) }}</option>
          }
        </select>
        @if (showComparison) {
          <div class="comparison-controls">
            <button 
              class="mode-toggle" 
              [disabled]="!canCompare"
              [class.disabled]="!canCompare"
              (click)="canCompare && toggleComparisonMode()" 
              [title]="comparisonTooltip">
              @if (comparisonMode === 'individual') {
                <span>📊</span>
              } @else {
                <span>📋</span>
              }
            </button>
          </div>
        }
      </div>
    </div>

    @if (comparisonMode === 'compare' && selectedSession) {
      <app-session-comparison-table
        [session1]="getCurrentSessionAsTestSession()"
        [session2]="selectedSession"
        [session1Label]="'Examen Actual'"
        [session2Label]="formatSessionForDropdown(selectedSession)">
      </app-session-comparison-table>
    }

    <div class="results-table-container">
      <table class="results-table">
        <thead>
          <tr>
            <th>Sección</th>
            <th>Preguntas</th>
            <th>Correctas</th>
            <th>Incorrectas</th>
            <th>En blanco</th>
            <th>Puntuación</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          @if (selectedSession && selectedSessionId !== 'current' && comparisonMode === 'individual') {
            <tr class="section-row">
              <td class="section-name">Total</td>
              <td class="question-count">{{ selectedSession.questionsAnswered }}</td>
              <td class="correct-count">
                <span class="count-badge correct">{{ selectedSession.correctAnswers }}</span>
              </td>
              <td class="wrong-count">
                <span class="count-badge wrong">{{ selectedSession.incorrectAnswers }}</span>
              </td>
              <td class="blank-count">
                <span class="count-badge blank">{{ selectedSession.blankAnswers || 0 }}</span>
              </td>
              <td class="score-value">
                <strong>{{ formatSpanishNumber(selectedSession.testScore || selectedSession.score || 0, 2) }}</strong>
              </td>
              <td class="status-indicator">
                @if (getHistoricalAccuracy() >= 85) {
                  <span class="status-badge excellent">Excelente</span>
                } @else if (getHistoricalAccuracy() >= 70) {
                  <span class="status-badge good">Bueno</span>
                } @else {
                  <span class="status-badge needs-improvement">Mejorar</span>
                }
              </td>
            </tr>
          } @else {
            @for (section of sectionsInOrder; track section) {
              <tr class="section-row">
                <td class="section-name">{{ getSectionDisplayName(section) }}</td>
                <td class="question-count">
                  {{ correctAnswers[section].correct + correctAnswers[section].incorrect }}
                </td>
                <td class="correct-count">
                  <span class="count-badge correct">{{ correctAnswers[section].correct }}</span>
                </td>
                <td class="wrong-count">
                  <span class="count-badge wrong">{{ correctAnswers[section].incorrect }}</span>
                </td>
                <td class="blank-count">
                  <span class="count-badge blank">{{ correctAnswers[section].blank }}</span>
                </td>
                <td class="score-value">
                  <strong>{{ formatSpanishNumber(correctAnswers[section].correct - (0.33 * correctAnswers[section].incorrect), 2) }}</strong>
                </td>
                <td class="status-indicator">
                  @if (getSectionPerformanceLevel(section) === 'excellent') {
                    <span class="status-badge excellent">Excelente</span>
                  } @else if (getSectionPerformanceLevel(section) === 'good') {
                    <span class="status-badge good">Bueno</span>
                  } @else {
                    <span class="status-badge needs-improvement">Mejorar</span>
                  }
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  }

      </div>
    } @else if (activeTab === 'charts') {
      <div class="charts-tab">
        <app-charts-container
          [currentData]="getChartData()"
          [previousSessions]="previousSessions"
          [selectedSessionId]="selectedSessionId"
          [selectedSession]="selectedSession"
          [showComparison]="showComparison"
          [comparisonMode]="comparisonMode"
          [canCompare]="canCompare"
          [comparisonTooltip]="comparisonTooltip"
          [isProgressTracking]="isProgressTracking"
          (sessionChanged)="onChartSessionChanged($event)"
          (comparisonModeChanged)="onChartComparisonModeChanged($event)">
        </app-charts-container>
      </div>
    }
    </div>
  </div>

  <div class="action-buttons">
    @if (isProgressTracking && progressSession) {
      <button class="btn btn-info" (click)="continueSession()">
        <fa-icon [icon]="faPlay"></fa-icon>
        <span>Continuar sesión</span>
      </button>
      <button class="btn btn-secondary" (click)="handleCloseClick()">
        <fa-icon [icon]="faTimes"></fa-icon>
        <span>Cerrar sin guardar</span>
      </button>
      <button 
        class="btn btn-success" 
        [disabled]="!hasTrackingData"
        [class.disabled]="!hasTrackingData"
        [title]="saveTooltip"
        (click)="saveAndClose()">
        <fa-icon [icon]="faCheck"></fa-icon>
        @if (selectedSession && selectedSessionId !== 'current') {
          <span>Guardar sesión actual y finalizar</span>
        } @else {
          <span>Guardar y finalizar</span>
        }
      </button>
    } @else {
      <button class="btn btn-primary" (click)="reviewAnswers()">
        <fa-icon [icon]="faEye"></fa-icon>
        <span>Comprobar respuestas</span>
      </button>
      <button class="btn btn-secondary" (click)="handleCloseClick()">
        <fa-icon [icon]="faTimes"></fa-icon>
        <span>Salir sin guardar</span>
      </button>
      <button class="btn btn-success" (click)="saveTestAndClose()">
        <fa-icon [icon]="faCheck"></fa-icon>
        <span>Guardar y finalizar</span>
      </button>
    }
  </div>
  }
</div>
